{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<style>
.video-upload-progress {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 99999;
    justify-content: center;
    align-items: center;
}

.progress-content {
    background: white;
    padding: 40px;
    border-radius: 8px;
    text-align: center;
    min-width: 400px;
}

.progress-bar-container {
    width: 100%;
    height: 30px;
    background: #f0f0f0;
    border-radius: 15px;
    overflow: hidden;
    margin: 20px 0;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50, #8BC34A);
    width: 0%;
    transition: width 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
}

.progress-message {
    font-size: 18px;
    margin-bottom: 10px;
    color: #333;
}

.progress-detail {
    font-size: 14px;
    color: #666;
    margin-top: 10px;
}

.comparison-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin: 20px 0;
    text-align: left;
}

.stat-box {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 4px;
}

.stat-box h4 {
    margin: 0 0 10px 0;
    color: #333;
}

.stat-box p {
    margin: 5px 0;
    font-size: 13px;
    color: #666;
}

.stat-box .highlight {
    font-size: 18px;
    font-weight: bold;
    color: #4CAF50;
}

.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #4CAF50;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 20px auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block submit_buttons_bottom %}
{{ block.super }}

<!-- Progress Modal -->
<div class="video-upload-progress" id="progressModal">
    <div class="progress-content">
        <div class="progress-message" id="progressMessage">
            Preparing to upload video...
        </div>
        <div class="spinner"></div>
        <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar">0%</div>
        </div>
        <div class="progress-detail" id="progressDetail">
            This may take a few moments...
        </div>
        <div id="compressionStats" style="display: none;">
            <div class="comparison-stats">
                <div class="stat-box">
                    <h4>üìπ Original</h4>
                    <p><strong>Size:</strong> <span id="originalSize">-</span></p>
                    <p><strong>Resolution:</strong> <span id="originalRes">-</span></p>
                </div>
                <div class="stat-box">
                    <h4>‚ú® Compressed</h4>
                    <p><strong>Size:</strong> <span id="compressedSize" class="highlight">-</span></p>
                    <p><strong>Resolution:</strong> <span id="compressedRes">-</span></p>
                    <p><strong>Savings:</strong> <span id="savings" class="highlight">-</span></p>
                </div>
            </div>
        </div>
        <button 
            id="cancelButton" 
            style="margin-top: 20px; padding: 10px 20px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; display: none;"
            onclick="cancelCompression()">
            Cancel Compression
        </button>
    </div>
</div>

<script>
(function() {
    const form = document.querySelector('form');
    const videoField = document.querySelector('input[name="video"]');
    const progressModal = document.getElementById('progressModal');
    const progressMessage = document.getElementById('progressMessage');
    const progressDetail = document.getElementById('progressDetail');
    const progressBar = document.getElementById('progressBar');
    const cancelButton = document.getElementById('cancelButton');
    const compressionStats = document.getElementById('compressionStats');
    
    let progressInterval;
    let startTime;
    let currentTaskId = null;
    let originalFileSize = 0;
    
    // Cancel compression function
    window.cancelCompression = function() {
        if (currentTaskId && confirm('Are you sure you want to cancel the compression?')) {
            fetch(`/admin/cancel-compression/${currentTaskId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('Cancellation requested:', data);
                updateProgress(0, 'Cancelling...', 'Cleaning up files...');
                cancelButton.style.display = 'none';
                
                // Stop polling
                if (progressInterval) {
                    clearInterval(progressInterval);
                }
                
                // Hide modal after a moment
                setTimeout(() => {
                    progressModal.style.display = 'none';
                    // Reload page to reset form
                    window.location.reload();
                }, 2000);
            })
            .catch(error => {
                console.error('Error cancelling:', error);
                alert('Failed to cancel compression. Please refresh the page.');
            });
        }
    };
    
    // Check file size before upload
    const qualityField = document.querySelector('select[name="compression_quality"]');
    
    if (videoField) {
        videoField.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                originalFileSize = file.size; // Store for later
                const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                const sizeElement = document.createElement('div');
                sizeElement.style.cssText = 'margin-top: 5px; padding: 10px; background: #e8f5e9; border-left: 4px solid #4CAF50; font-size: 14px;';
                
                if (file.size > 100 * 1024 * 1024) { // Over 100MB
                    const qualityPreset = qualityField ? qualityField.options[qualityField.selectedIndex].text : 'Balanced (720p)';
                    sizeElement.innerHTML = `
                        <strong>üìπ File size: ${sizeMB} MB</strong><br>
                        <span style="color: #ff9800;">‚ö†Ô∏è This file will be automatically compressed before upload.</span><br>
                        <small>Quality: ${qualityPreset} | Estimated time: ${estimateCompressionTime(file.size)}</small>
                    `;
                    sizeElement.style.background = '#fff3e0';
                    sizeElement.style.borderLeftColor = '#ff9800';
                    
                    // Highlight quality selector
                    if (qualityField) {
                        const qualityRow = qualityField.closest('.form-row');
                        if (qualityRow) {
                            qualityRow.style.background = '#fffbe6';
                            qualityRow.style.padding = '10px';
                            qualityRow.style.borderRadius = '4px';
                            qualityRow.style.marginTop = '10px';
                        }
                    }
                } else {
                    sizeElement.innerHTML = `
                        <strong>‚úì File size: ${sizeMB} MB</strong><br>
                        <span style="color: #4CAF50;">No compression needed!</span>
                    `;
                    
                    // Remove highlight from quality selector
                    if (qualityField) {
                        const qualityRow = qualityField.closest('.form-row');
                        if (qualityRow) {
                            qualityRow.style.background = '';
                            qualityRow.style.padding = '';
                        }
                    }
                }
                
                // Remove any existing size display
                const existing = videoField.parentElement.querySelector('.file-size-info');
                if (existing) existing.remove();
                
                sizeElement.className = 'file-size-info';
                videoField.parentElement.appendChild(sizeElement);
            }
        });
        
        // Update quality info when quality selector changes
        if (qualityField) {
            qualityField.addEventListener('change', function() {
                const file = videoField.files[0];
                if (file && file.size > 100 * 1024 * 1024) {
                    // Trigger change event to update the info display
                    videoField.dispatchEvent(new Event('change'));
                }
            });
        }
    }
    
    function estimateCompressionTime(fileSize) {
        const sizeMB = fileSize / (1024 * 1024);
        const seconds = Math.ceil(sizeMB / 3); // Rough estimate: 3MB per second
        if (seconds < 60) {
            return `~${seconds} seconds`;
        } else {
            const minutes = Math.ceil(seconds / 60);
            return `~${minutes} minute${minutes > 1 ? 's' : ''}`;
        }
    }
    
    function updateProgress(percent, message, detail) {
        progressBar.style.width = percent + '%';
        progressBar.textContent = percent + '%';
        if (message) progressMessage.textContent = message;
        if (detail) progressDetail.textContent = detail;
    }
    
    function pollProgress(taskId) {
        currentTaskId = taskId;
        cancelButton.style.display = 'inline-block'; // Show cancel button
        
        const poll = () => {
            fetch(`/admin/compression-progress/${taskId}/`)
                .then(response => response.json())
                .then(data => {
                    console.log('Progress update:', data);
                    
                    updateProgress(
                        data.percentage,
                        data.stage,
                        data.details
                    );
                    
                    // Update elapsed time
                    if (startTime) {
                        const elapsed = Math.floor((Date.now() - startTime) / 1000);
                        const minutes = Math.floor(elapsed / 60);
                        const seconds = elapsed % 60;
                        const timeStr = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
                        progressDetail.textContent = data.details + ` (Elapsed: ${timeStr})`;
                    }
                    
                    // Stop polling if complete or error
                    if (data.status === 'complete' || data.status === 'error' || data.stage === 'Cancelled') {
                        clearInterval(progressInterval);
                        cancelButton.style.display = 'none';
                        
                        if (data.status === 'complete') {
                            updateProgress(100, 'Compression complete!', data.details);
                            
                            // Show compression stats
                            if (data.final_size_mb && originalFileSize) {
                                showCompressionStats(originalFileSize, data.final_size_mb);
                            }
                            
                            setTimeout(() => {
                                progressModal.style.display = 'none';
                                compressionStats.style.display = 'none';
                            }, 5000); // Show stats for 5 seconds
                        } else if (data.stage === 'Cancelled') {
                            updateProgress(0, 'Cancelled', 'Compression was cancelled');
                            setTimeout(() => {
                                progressModal.style.display = 'none';
                            }, 2000);
                        } else {
                            updateProgress(0, 'Error occurred', data.details);
                            setTimeout(() => {
                                progressModal.style.display = 'none';
                            }, 3000);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error polling progress:', error);
                });
        };
        
        // Start polling every 500ms
        progressInterval = setInterval(poll, 500);
        poll(); // Call immediately
    }
    
    function showCompressionStats(originalBytes, compressedMB) {
        const originalMB = originalBytes / (1024 * 1024);
        const savings = ((originalMB - compressedMB) / originalMB * 100).toFixed(1);
        
        document.getElementById('originalSize').textContent = originalMB.toFixed(1) + ' MB';
        document.getElementById('originalRes').textContent = 'Original Quality';
        document.getElementById('compressedSize').textContent = compressedMB.toFixed(1) + ' MB';
        document.getElementById('compressedRes').textContent = '720p (1280x720)';
        document.getElementById('savings').textContent = savings + '% smaller';
        
        compressionStats.style.display = 'block';
    }
    
    // Show progress on form submit
    if (form) {
        form.addEventListener('submit', function(e) {
            const file = videoField ? videoField.files[0] : null;
            
            console.log('Form submitted, file:', file);
            console.log('File size:', file ? file.size : 'no file');
            console.log('Is large file?', file && file.size > 100 * 1024 * 1024);
            
            if (file && file.size > 100 * 1024 * 1024) {
                console.log('SHOWING PROGRESS MODAL');
                
                // Prevent default form submission temporarily
                e.preventDefault();
                
                // Show progress modal for large files
                progressModal.style.display = 'flex';
                startTime = Date.now();
                updateProgress(0, 'Starting compression...', 'Preparing video file...');
                
                // Submit form via AJAX to keep page alive for progress tracking
                const formData = new FormData(form);
                
                fetch(form.action || window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                }).then(response => {
                    console.log('Form submitted via AJAX, starting task polling...');
                    
                    // Poll for the task ID from the server
                    const checkForTask = () => {
                        fetch('/admin/get-latest-task/')
                            .then(response => response.json())
                            .then(data => {
                                console.log('Task check response:', data);
                                if (data.task_id) {
                                    console.log('Found task ID:', data.task_id);
                                    pollProgress(data.task_id);
                                } else {
                                    console.log('No task yet, checking again...');
                                    // Keep checking every 500ms until task is created
                                    setTimeout(checkForTask, 500);
                                }
                            })
                            .catch(error => {
                                console.error('Error getting task ID:', error);
                                setTimeout(checkForTask, 500);
                            });
                    };
                    
                    // Start checking for task immediately
                    setTimeout(checkForTask, 500);
                }).catch(error => {
                    console.error('Form submission error:', error);
                    progressModal.style.display = 'none';
                    alert('Error submitting form: ' + error.message);
                });
                
            } else {
                console.log('Small file or no file, allowing normal submission');
                // Let small files submit normally
            }
        });
    }
    
    // Clean up on page unload
    window.addEventListener('beforeunload', function() {
        if (progressInterval) {
            clearInterval(progressInterval);
        }
    });
})();
</script>
{% endblock %}
