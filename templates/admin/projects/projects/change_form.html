{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<style>
/* Batch upload styles */
.batch-upload-section {
    background: #f8f9fa;
    padding: 20px;
    margin: 20px 0;
    border-radius: 8px;
    border: 2px dashed #4CAF50;
}

.batch-upload-title {
    font-size: 16px;
    font-weight: bold;
    margin-bottom: 15px;
    color: #333;
}

.batch-upload-input {
    display: block;
    width: 100%;
    padding: 15px;
    background: white;
    border: 2px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    margin-bottom: 10px;
}

.batch-upload-input:hover {
    border-color: #4CAF50;
    background: #f1f8f4;
}

.batch-upload-info {
    font-size: 13px;
    color: #666;
    margin-top: 10px;
}

.batch-upload-progress {
    display: none;
    margin-top: 15px;
    padding: 15px;
    background: white;
    border-radius: 4px;
    border-left: 4px solid #2196F3;
}

.video-upload-progress {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 99999;
    justify-content: center;
    align-items: center;
}

.progress-content {
    background: white;
    padding: 40px;
    border-radius: 8px;
    text-align: center;
    min-width: 400px;
}

.progress-bar-container {
    width: 100%;
    height: 30px;
    background: #f0f0f0;
    border-radius: 15px;
    overflow: hidden;
    margin: 20px 0;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50, #8BC34A);
    width: 0%;
    transition: width 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
}

.progress-message {
    font-size: 18px;
    margin-bottom: 10px;
    font-weight: 600;
    color: #333;
}

.progress-detail {
    font-size: 14px;
    color: #666;
    margin-top: 10px;
}

.cancel-button {
    margin-top: 20px;
    padding: 10px 20px;
    background: #f44336;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

.cancel-button:hover {
    background: #d32f2f;
}
</style>
{% endblock %}

{% block after_field_sets %}
{{ block.super }}

<!-- Progress Modal -->
<div id="progressModal" class="video-upload-progress">
    <div class="progress-content">
        <div class="progress-message" id="progressMessage">Compressing video...</div>
        <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar">0%</div>
        </div>
        <div class="progress-detail" id="progressDetail">Please wait...</div>
        <button id="cancelButton" class="cancel-button" onclick="cancelCompression()" style="display: none;">
            Cancel Compression
        </button>
    </div>
</div>

<script>
// BATCH UPLOAD SCRIPT - LAST UPDATED: 2025-10-27 23:45:00 UTC - VERSION 2.1
(function() {
    const form = document.querySelector('form');
    const progressModal = document.getElementById('progressModal');
    const progressMessage = document.getElementById('progressMessage');
    const progressDetail = document.getElementById('progressDetail');
    const progressBar = document.getElementById('progressBar');
    const cancelButton = document.getElementById('cancelButton');
    
    let progressInterval;
    let startTime;
    let currentTaskId = null;
    
    // ========== INJECT BATCH UPLOAD BUTTONS ==========
    
    // Wait for Django's inline formset JavaScript to finish initializing
    function injectBatchUploadButtons() {
        console.log('üîç üîç üîç BATCH UPLOAD SCRIPT LOADED - TIMESTAMP:', new Date().toISOString());
        console.log('Looking for inline sections...');
        
        // Find photo inline section - CORRECT SELECTOR
        const photoInline = document.querySelector('#photos-group');
        console.log('Photos inline (#photos-group) found:', photoInline ? 'YES ‚úÖ' : 'NO ‚ùå');
        if (photoInline) {
            console.log('Photo inline HTML:', photoInline.outerHTML.substring(0, 200));
        }
        
        if (photoInline) {
            // Check if button already exists
            if (!document.getElementById('batchPhotoUpload')) {
                const batchPhotoHTML = `
                    <div style="background: #e8f5e9; padding: 15px; margin-bottom: 15px; border-radius: 4px; border-left: 4px solid #4CAF50;">
                        <input type="file" id="batchPhotoUpload" accept="image/*" multiple style="display: none;">
                        <button type="button" onclick="document.getElementById('batchPhotoUpload').click()" 
                                style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                            üì∏ Select Multiple Photos
                        </button>
                        <span style="margin-left: 10px; color: #666; font-size: 13px;">Click to select multiple image files at once</span>
                        <div id="photoUploadProgress" style="display: none; margin-top: 10px; color: #4CAF50; font-weight: bold;"></div>
                    </div>
                `;
                photoInline.insertAdjacentHTML('afterbegin', batchPhotoHTML);
                console.log('‚úÖ Photo batch button injected!');
            } else {
                console.log('‚ö†Ô∏è Photo batch button already exists');
            }
        }
        
        // Find video inline section - CORRECT SELECTOR
        const videoInline = document.querySelector('#videos-group');
        console.log('Videos inline (#videos-group) found:', videoInline ? 'YES ‚úÖ' : 'NO ‚ùå');
        if (videoInline) {
            console.log('Video inline HTML:', videoInline.outerHTML.substring(0, 200));
        }
        
        if (videoInline) {
            // Check if button already exists
            if (!document.getElementById('batchVideoUpload')) {
                const batchVideoHTML = `
                    <div style="background: #e3f2fd; padding: 15px; margin-bottom: 15px; border-radius: 4px; border-left: 4px solid #2196F3;">
                        <input type="file" id="batchVideoUpload" accept="video/*" multiple style="display: none;">
                        <button type="button" onclick="document.getElementById('batchVideoUpload').click()" 
                                style="padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                            üé¨ Select Multiple Videos
                        </button>
                        <span style="margin-left: 10px; color: #666; font-size: 13px;">Click to select multiple video files at once</span>
                        <div id="videoUploadProgress" style="display: none; margin-top: 10px; color: #2196F3; font-weight: bold;"></div>
                    </div>
                `;
                videoInline.insertAdjacentHTML('afterbegin', batchVideoHTML);
                console.log('‚úÖ Video batch button injected!');
            } else {
                console.log('‚ö†Ô∏è Video batch button already exists');
            }
        }
    }
    
    // Try multiple times with increasing delays to ensure Django's JS is loaded
    window.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ DOMContentLoaded fired');
        
        // Try immediately
        setTimeout(injectBatchUploadButtons, 0);
        
        // Try again after Django's inline JS should be loaded
        setTimeout(injectBatchUploadButtons, 500);
        
        // Final attempt
        setTimeout(injectBatchUploadButtons, 1000);
    });
    
    // Also try when page is fully loaded
    window.addEventListener('load', function() {
        console.log('üöÄ Load event fired');
        setTimeout(injectBatchUploadButtons, 100);
    });
    
    // ========== BATCH UPLOAD HANDLERS ==========
    
    // Batch Photo Upload
    document.addEventListener('change', function(e) {
        if (e.target.id === 'batchPhotoUpload') {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            console.log(`üì∏ Processing ${files.length} photos...`);
            
            const progressDiv = document.getElementById('photoUploadProgress');
            progressDiv.style.display = 'block';
            progressDiv.innerHTML = `Processing ${files.length} photo(s)...`;
            
            // Find the photos inline formset - CORRECT SELECTOR
            const photoInline = document.querySelector('#photos-group');
            if (!photoInline) {
                alert('Could not find photos section');
                console.error('‚ùå #photos-group not found!');
                return;
            }
            
            const addButton = photoInline.querySelector('.add-row a');
            const totalFormsInput = document.querySelector('#id_photos-TOTAL_FORMS');
            const maxFormsInput = document.querySelector('#id_photos-MAX_NUM_FORMS');
            
            console.log('Add button found:', addButton ? 'YES' : 'NO');
            console.log('Current TOTAL_FORMS:', totalFormsInput?.value);
            console.log('MAX_NUM_FORMS:', maxFormsInput?.value);
            
            // Check if we have room
            const currentTotal = parseInt(totalFormsInput?.value || 0);
            const maxForms = parseInt(maxFormsInput?.value || 1000);
            
            if (currentTotal + files.length > maxForms) {
                alert(`Cannot add ${files.length} photos. Maximum is ${maxForms} total forms, currently at ${currentTotal}.`);
                progressDiv.style.display = 'none';
                return;
            }
            
            let processedCount = 0;
            
            files.forEach((file, index) => {
                setTimeout(() => {
                    // Click add button to create new form
                    if (addButton) {
                        addButton.click();
                        console.log(`Clicked add button for file ${index + 1}`);
                    }
                    
                    // Wait for Django's inline JS to finish creating the row
                    setTimeout(() => {
                        // Find all photo forms - CORRECT SELECTOR
                        const photoForms = photoInline.querySelectorAll('.dynamic-photos');
                        const lastForm = photoForms[photoForms.length - 1];
                        
                        console.log(`Adding file ${index + 1}/${files.length}: ${file.name}`);
                        console.log(`Total forms now: ${photoForms.length}`);
                        
                        if (lastForm) {
                            // Find the file input in the new form
                            const fileInput = lastForm.querySelector('input[type="file"]');
                            if (fileInput) {
                                // Create a DataTransfer object to set files
                                const dataTransfer = new DataTransfer();
                                dataTransfer.items.add(file);
                                fileInput.files = dataTransfer.files;
                                fileInput.dispatchEvent(new Event('change', { bubbles: true }));
                                console.log(`‚úì File assigned to input: ${fileInput.name}`);
                            }
                            
                            // Set caption from filename
                            const captionInput = lastForm.querySelector('input[name*="caption"]');
                            if (captionInput && !captionInput.value) {
                                captionInput.value = file.name.replace(/\.[^/.]+$/, "");
                            }
                            
                            // Set order
                            const orderInput = lastForm.querySelector('input[name*="order"]');
                            if (orderInput) {
                                // Start order from current max + 1
                                const existingOrders = Array.from(photoInline.querySelectorAll('input[name*="order"]'))
                                    .map(input => parseInt(input.value) || 0)
                                    .filter(val => val > 0);
                                const maxOrder = existingOrders.length > 0 ? Math.max(...existingOrders) : 0;
                                orderInput.value = maxOrder + index + 1;
                            }
                        }
                        
                        processedCount++;
                        
                        // Update progress
                        progressDiv.innerHTML = `Processing ${processedCount}/${files.length}...`;
                        
                        if (processedCount === files.length) {
                            progressDiv.innerHTML = `‚úì Added ${files.length} photos! Click Save to upload.`;
                            console.log(`‚úÖ Successfully added ${files.length} photos!`);
                            setTimeout(() => {
                                progressDiv.style.display = 'none';
                                e.target.value = '';
                            }, 3000);
                        }
                    }, 300); // Wait 300ms for Django inline JS to finish
                }, index * 500); // Space out the add clicks by 500ms
            });
        }
        
        // Batch Video Upload
        if (e.target.id === 'batchVideoUpload') {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            console.log(`üé¨ Processing ${files.length} videos...`);
            
            const progressDiv = document.getElementById('videoUploadProgress');
            progressDiv.style.display = 'block';
            progressDiv.innerHTML = `Processing ${files.length} video(s)...`;
            
            // Find the videos inline formset - CORRECT SELECTOR
            const videoInline = document.querySelector('#videos-group');
            if (!videoInline) {
                alert('Could not find videos section');
                console.error('‚ùå #videos-group not found!');
                return;
            }
            
            const addButton = videoInline.querySelector('.add-row a');
            const totalFormsInput = document.querySelector('#id_videos-TOTAL_FORMS');
            const maxFormsInput = document.querySelector('#id_videos-MAX_NUM_FORMS');
            
            console.log('Add button found:', addButton ? 'YES' : 'NO');
            console.log('Current TOTAL_FORMS:', totalFormsInput?.value);
            console.log('MAX_NUM_FORMS:', maxFormsInput?.value);
            
            // Check if we have room
            const currentTotal = parseInt(totalFormsInput?.value || 0);
            const maxForms = parseInt(maxFormsInput?.value || 1000);
            
            if (currentTotal + files.length > maxForms) {
                alert(`Cannot add ${files.length} videos. Maximum is ${maxForms} total forms, currently at ${currentTotal}.`);
                progressDiv.style.display = 'none';
                return;
            }
            
            let processedCount = 0;
            
            files.forEach((file, index) => {
                setTimeout(() => {
                    // Click add button to create new form
                    if (addButton) {
                        addButton.click();
                        console.log(`Clicked add button for file ${index + 1}`);
                    }
                    
                    // Wait for Django's inline JS to finish creating the row
                    setTimeout(() => {
                        // Find all video forms - CORRECT SELECTOR
                        const videoForms = videoInline.querySelectorAll('.dynamic-videos');
                        const lastForm = videoForms[videoForms.length - 1];
                        
                        console.log(`Adding file ${index + 1}/${files.length}: ${file.name}`);
                        console.log(`Total forms now: ${videoForms.length}`);
                        
                        if (lastForm) {
                            // Find the file input in the new form
                            const fileInput = lastForm.querySelector('input[type="file"]');
                            if (fileInput) {
                                const dataTransfer = new DataTransfer();
                                dataTransfer.items.add(file);
                                fileInput.files = dataTransfer.files;
                                fileInput.dispatchEvent(new Event('change', { bubbles: true }));
                                console.log(`‚úì File assigned to input: ${fileInput.name}`);
                            }
                            
                            // Set caption from filename
                            const captionInput = lastForm.querySelector('input[name*="caption"]');
                            if (captionInput && !captionInput.value) {
                                captionInput.value = file.name.replace(/\.[^/.]+$/, "");
                            }
                            
                            // Set order
                            const orderInput = lastForm.querySelector('input[name*="order"]');
                            if (orderInput) {
                                // Start order from current max + 1
                                const existingOrders = Array.from(videoInline.querySelectorAll('input[name*="order"]'))
                                    .map(input => parseInt(input.value) || 0)
                                    .filter(val => val > 0);
                                const maxOrder = existingOrders.length > 0 ? Math.max(...existingOrders) : 0;
                                orderInput.value = maxOrder + index + 1;
                            }
                        }
                        
                        processedCount++;
                        
                        // Update progress
                        progressDiv.innerHTML = `Processing ${processedCount}/${files.length}...`;
                        
                        if (processedCount === files.length) {
                            const sizeMB = files.reduce((sum, f) => sum + f.size, 0) / (1024 * 1024);
                            progressDiv.innerHTML = `‚úì Added ${files.length} videos (${sizeMB.toFixed(2)}MB)! Click Save to upload.`;
                            console.log(`‚úÖ Successfully added ${files.length} videos!`);
                            setTimeout(() => {
                                progressDiv.style.display = 'none';
                                e.target.value = '';
                            }, 3000);
                        }
                    }, 300); // Wait 300ms for Django inline JS to finish
                }, index * 500); // Space out the add clicks by 500ms
            });
        }
    });
    
    // ========== EXISTING COMPRESSION/PROGRESS CODE ==========
    
    // Cancel compression function
    window.cancelCompression = function() {
        if (currentTaskId && confirm('Are you sure you want to cancel the compression?')) {
            fetch(`/admin/cancel-compression/${currentTaskId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('Cancellation requested:', data);
                updateProgress(0, 'Cancelling...', 'Cleaning up files...');
                cancelButton.style.display = 'none';
                
                if (progressInterval) {
                    clearInterval(progressInterval);
                }
                
                setTimeout(() => {
                    progressModal.style.display = 'none';
                    window.location.reload();
                }, 2000);
            })
            .catch(error => {
                console.error('Error cancelling:', error);
                alert('Failed to cancel compression. Please refresh the page.');
            });
        }
    };
    
    function updateProgress(percent, message, detail) {
        progressBar.style.width = percent + '%';
        progressBar.textContent = percent + '%';
        if (message) progressMessage.textContent = message;
        if (detail) progressDetail.textContent = detail;
    }
    
    function pollProgress(taskId) {
        currentTaskId = taskId;
        cancelButton.style.display = 'inline-block';
        
        progressInterval = setInterval(() => {
            fetch(`/admin/compression-progress/${taskId}/`)
                .then(response => response.json())
                .then(data => {
                    console.log('Progress update:', data);
                    
                    updateProgress(data.percentage, data.stage, data.details);
                    
                    if (startTime) {
                        const elapsed = Math.floor((Date.now() - startTime) / 1000);
                        const minutes = Math.floor(elapsed / 60);
                        const seconds = elapsed % 60;
                        const timeStr = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
                        progressDetail.textContent = data.details + ` (Elapsed: ${timeStr})`;
                    }
                    
                    if (data.status === 'complete' || data.status === 'error' || data.stage === 'Cancelled') {
                        clearInterval(progressInterval);
                        cancelButton.style.display = 'none';
                        
                        if (data.status === 'complete') {
                            updateProgress(100, 'Compression complete!', data.details);
                            setTimeout(() => {
                                progressModal.style.display = 'none';
                                // Reload to show the uploaded video
                                window.location.reload();
                            }, 3000);
                        } else if (data.stage === 'Cancelled') {
                            updateProgress(0, 'Cancelled', 'Compression was cancelled');
                            setTimeout(() => {
                                progressModal.style.display = 'none';
                            }, 2000);
                        } else {
                            updateProgress(0, 'Error occurred', data.details);
                            setTimeout(() => {
                                progressModal.style.display = 'none';
                            }, 3000);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error polling progress:', error);
                });
        }, 500);
    }
    
    // Monitor file inputs in inline forms
    function checkVideoFields() {
        const videoFields = document.querySelectorAll('input[type="file"][name*="video"]');
        console.log('Found video fields:', videoFields.length);
        
        videoFields.forEach(field => {
            if (field.dataset.listenerAdded) return;
            field.dataset.listenerAdded = 'true';
            
            field.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    console.log('Video selected:', file.name, file.size);
                    const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                    const sizeElement = document.createElement('div');
                    sizeElement.style.cssText = 'margin-top: 5px; padding: 10px; background: #fff3e0; border-left: 4px solid #ff9800; font-size: 12px;';
                    
                    if (file.size > 100 * 1024 * 1024) {
                        sizeElement.innerHTML = `
                            <strong>üìπ ${sizeMB} MB</strong> - Will be compressed before upload
                        `;
                    } else {
                        sizeElement.innerHTML = `<strong>‚úì ${sizeMB} MB</strong>`;
                        sizeElement.style.background = '#e8f5e9';
                        sizeElement.style.borderLeftColor = '#4CAF50';
                    }
                    
                    const existing = field.parentElement.querySelector('.file-size-info');
                    if (existing) existing.remove();
                    
                    sizeElement.className = 'file-size-info';
                    field.parentElement.appendChild(sizeElement);
                }
            });
        });
    }
    
    // Check on load and when inlines are added
    checkVideoFields();
    
    // Watch for dynamically added inline forms
    const observer = new MutationObserver(() => {
        checkVideoFields();
    });
    
    const inlineContainer = document.querySelector('.inline-group');
    if (inlineContainer) {
        observer.observe(inlineContainer, { childList: true, subtree: true });
    }
    
    // Show progress on form submit
    if (form) {
        form.addEventListener('submit', function(e) {
            const videoFields = document.querySelectorAll('input[type="file"][name*="video"]');
            let hasLargeVideo = false;
            
            videoFields.forEach(field => {
                const file = field.files[0];
                if (file && file.size > 100 * 1024 * 1024) {
                    hasLargeVideo = true;
                }
            });
            
            console.log('Form submitted, has large video:', hasLargeVideo);
            
            if (hasLargeVideo) {
                console.log('SHOWING PROGRESS MODAL');
                progressModal.style.display = 'flex';
                startTime = Date.now();
                updateProgress(0, 'Starting compression...', 'Preparing video file...');
                
                // Poll for the task ID
                const checkForTask = () => {
                    fetch('/admin/get-latest-task/')
                        .then(response => response.json())
                        .then(data => {
                            console.log('Task check response:', data);
                            if (data.task_id) {
                                console.log('Found task ID:', data.task_id);
                                pollProgress(data.task_id);
                            } else {
                                console.log('No task yet, checking again...');
                                setTimeout(checkForTask, 500);
                            }
                        })
                        .catch(error => {
                            console.error('Error getting task ID:', error);
                            setTimeout(checkForTask, 500);
                        });
                };
                
                setTimeout(checkForTask, 1000);
            }
        });
    }
    
    window.addEventListener('beforeunload', function() {
        if (progressInterval) {
            clearInterval(progressInterval);
        }
    });
})();
</script>
{% endblock %}
